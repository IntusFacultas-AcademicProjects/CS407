{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Account Settings{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-primary">
            <div class="panel-heading filter-collapsed-bar">
                <div class="row">   
                    <div class="col-lg-11">
                        <h4>Account Information</h4>
                    </div>
                    <div class="col-lg-1">
                        <i class="fa fa-chevron-down fa-2x" style="display:none;" aria-hidden="true"></i>
                        <i class="fa fa-chevron-up fa-2x"  aria-hidden="true"></i>
                    </div>
                </div>
            </div>
            <div class="panel-body">
                <span>Account Type: {{ account_type }}</span>
                <div class="row">
                    <div class="col-lg-9">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="thumbnail">
                                    <form class="form-horizontal" style="margin:20px;" method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="form_type" value="account_form">
                                        {% for field in form %}
                                        <div class="form-group">
                                            {{ field.label_tag }}
                                            {% render_field field class+="form-control" %}
                                            {% if field.help_text %}
                                            <small class="form-text text-muted" >{{ field.help_text }}</small>
                                            {% endif %}
                                        </div>
                                        {% if field.errors|length > 0 %}
                                        <div class="form-group">
                                            <ul>
                                                {% for error in field.errors %}
                                                <li style="color: red">{{ error }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                        <button class="btn btn-primary" type="submit">Update Information</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-danger">
                                    <div class="panel-heading">
                                        Danger Area
                                    </div>
                                    <div class="panel-body">
                                         {% comment %}
                                        <!-- {% url 'app_name:url_name' %} gets replaced with the url that Django has on file with that name -->
                                        {% endcomment %}
                                        <form method="post" id="deleteAccount" action="{% url 'audition_management:delete-account' pk=user.id %}">
                                            <!-- CSRF is to protect against cross site request forgery attacks. This will be translated by
                                            django into:
                                            <input type="hidden" name="csrf_token" value="random_string_of_numbers_and_letters_that_only_you_can_have"> -->
                                            {% csrf_token %}
                                            <button class="btn btn-danger" type="button" onclick="confirm()">Delete Account</button><br>
                                            <span>
                                                This action cannot be undone. Administrators will not be able to recover your account. Think carefully before pressing this button. You will be prompted to confirm your choice.
                                            </span>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="thumbnail">
                                     <form class="form-horizontal" style="margin:20px;" method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="form_type" value="change_password_form">
                                        {% for field in change_password_form %}
                                        <div class="form-group">
                                            {{ field.label_tag }}
                                            {% render_field field class+="form-control" %}
                                            {% if field.help_text %}
                                            <small class="form-text text-muted">{{ field.help_text|safe }}
                                            </small>
                                            {% endif %}
                                        </div>
                                        {% if field.errors|length > 0 %}
                                        <div class="form-group">
                                            <ul>
                                                {% for error in field.errors %}
                                                <li style="color: red">{{ error }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                        <button class="btn btn-primary" type="submit">Change Password</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <!-- Button trigger modal -->
                                <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
                                  Watch Tutorial
                                </button>
                                <!-- Modal -->
                                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                <h4 class="modal-title" id="myModalLabel">Tutorial Video</h4>
                                            </div>
                                            <div class="modal-body">
                                                {% if is_casting %}
                                                {% else %}
                                                Coming Soon
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% if not is_casting %}
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h4>Professional Information</h4>
                    <small id="emailHelp" class="form-text text-muted">This section is visible to prospective agents looking to hire you. Tell us what you've done before, provide us some tags so we can match you with agents looking for people with your strengths!</small>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-lg-12">
                            <form class="form-horizontal" style="margin:20px;" method="post">
                                <div class="form-group">
                                    {% csrf_token %}
                                    <input type="hidden" name="form_type" value="portfolio_formset">
                                    <h4>Previous Work</h4>
                                    <small id="emailHelp" class="form-text text-muted">Provide a small description or name of a production you worked with!</small>
                                </div>
                                <div class="form-group">
                                    {{ portfolio_formset.management_form }}
                                    <table class="table table-striped">
                                        {% for form in portfolio_formset %}
                                            {% if forloop.first %}
                                                <thead>
                                                <tr>
                                                    {% for field in form.visible_fields %}
                                                        <th>{{ field.label|capfirst }}</th>
                                                    {% endfor %}
                                                </tr>
                                                </thead>
                                            {% endif %}
                                            <tr class="{% cycle 'row1' 'row2' %} formset_row">
                                                {% for field in form.visible_fields %}
                                                    <td>
                                                        {# Include the hidden fields in the form #}
                                                        {% if forloop.first %}
                                                            {% for hidden in form.hidden_fields %}
                                                                {{ hidden }}
                                                            {% endfor %}
                                                        {% endif %}
                                                        {% render_field field class+="form-control" %}
                                                        {% if field.errors|length > 0 %}
                                                        <div class="form-group">
                                                            <ul>
                                                                {% for error in field.errors %}
                                                                <li style="color: red">{{ error }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                        {% endif %}
                                                    </td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form> 
                        </div>
                    </div>
                    <hr style="margin-top:5px; margin-bottom:5px;">
                    <div class="row">
                        <div class="col-lg-12">
                            <form class="form-horizontal" style="margin:20px;" id="tagEdit" method="post">
                                {% csrf_token %}
                                <div class="form-group">
                                    <h4>Tags</h4>
                                    <small id="emailHelp" class="form-text text-muted">Tags are how you tell us the soft skills and attributes you have that you want us to match roles with. Skills like singing soprano, stunt work, and so would go here. It's best if you use single word tags.</small>
                                </div>
                                <div class="form-group">
                                    <span v-for="tag in tags" class="badge badge-success pull-left" v-bind:id="tag.id" style="padding:10px; margin: 2px;">
                                        ((tag.tag))
                                        <i style="cursor:pointer" v-on:click="deleteTag(tag.id)" class="fa fa-times-circle"></i>
                                    </span>
                                    <input type="hidden" name="update_tags" value="" id="updatedTags">
                                    <input type="hidden" name="form_type" value="tag_formset">
                                </div>
                                <div class="form-group">
                                    <input type="text" class="form-control" v-model="insert" v-on:input="updateTags(event)" v-on:keyup.delete="removeTags()">
                                    <small class="form-text text-muted" >To add new tags, simply write out the tag and put a comma "," at the end to delineate a new tag. To remove tags, you can click the X on the tags above, or continuously hit backspace (the tag to be deleted will be highlighted in red).</small><br>
                                </div>
                                <div class="form-group">
                                    <button id="submitForm" class="btn btn-primary" type="button" style="margin-top:10px" v-on:click="subForm">Save Changes</button>                       
                                </div>
                            </form>
                        </div>
                    </div>
                    <hr style="margin-top:5px; margin-bottom:5px;">
                    <div class="row">
                        <div class="col-lg-12">
                            <form class="form-horizontal" style="margin:20px;" method="post">
                                <div class="form-group">
                                    <input type="hidden" name="form_type" value="audition_form">
                                    <h4>Biological and Logistical Information</h4>
                                    <small id="emailHelp" class="form-text text-muted">Some roles require a certain age, gender, or location. Tell us about yourself, so we can match you better!</small>
                                </div>
                                {% csrf_token %}
                                {% for field in audition_form %}
                                <div class="form-group">
                                    {{ field.label_tag }}
                                    {% render_field field class+="form-control" %}
                                    {% if field.help_text %}
                                    <small class="form-text text-muted" >{{ field.help_text }}</small>
                                    {% endif %}
                                </div>
                                {% if field.errors|length > 0 %}
                                <div class="form-group">
                                    <ul>
                                        {% for error in field.errors %}
                                        <li style="color: red">{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                {% endfor %}
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                {% if not is_casting %}
                    <h4>Auditions</h4>
                {% else %}
                    <h4>Postings</h4>
                {% endif %}
            </div>
            <div class="panel-body">
                <div id="filterDiv">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="panel panel-info">
                                <div class="panel-heading filter-collapsed-bar-2">
                                    <div class="row">
                                        <div class="col-lg-11">
                                            Filter Options
                                        </div>
                                    </div>
                                </div>
                                <div class="panel-body">
                                    <div class="form-horizontal">
                                        <div class="form-group">
                                            <div class="col-lg-6">
                                                <label for="title" class="control-label">Contains Text:</label>
                                                <input id="title" type="text" class="form-control" v-model="filterText" placeholder="Enter text to filter by">
                                            </div>
                                            <div class="col-lg-6">
                                                <label for="tagSelect" class="control-label">Has Tags:</label>
                                                 <select class="form-control" style="width:100%" id="tagSelect" multiple>
                                                    <option v-for="tag, index in tags" v-bind:value="tag">
                                                        (( tag ))
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="col-lg-6">
                                                <label for="datetimepicker1" class="control-label">Dates After</label>
                                                <div class='input-group date' id='datetimepicker1'>
                                                    <input type='text' class="form-control" v-model="filterDate" />
                                                    <span class="input-group-addon">
                                                        <span class="glyphicon glyphicon-calendar"></span>
                                                    </span>
                                                </div>
                                                <small id="emailHelp" class="form-text text-muted">All roles will have a list of events that can be seen by clicking 'View' on a role. Filtering by dates will ensure that all events fall within the requested range</small>
                                            </div>
                                            <div class="col-lg-6">
                                                {% comment %}
                                                 <!-- eventually location filtering will be here -->
                                                {% endcomment %}
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="col-lg-9">
                                                
                                            </div>
                                            <div class="col-lg-3">
                                                <button v-on:click="resetFilters()" class="btn btn-warning" type="button">
                                                    Reset Filters
                                                </button>
                                                <button v-on:click="combinedFilter()" class="btn btn-primary" type="button">
                                                    Filter
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class='wrapper' style="height: 500px">
                                <table id="roles" class="table table-hover table-striped">
                                    <thead>
                                        <tr style="background-color:white;">
                                            <th>Role</th>
                                            <th>Casting Agent</th>
                                            <th>Location</th>
                                            <th>Tags</th>
                                            <th>&nbsp;</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="role in displayedRoles">
                                            <td>(( role.role.name ))</td>
                                            <td>(( role.role.agent ))</td>
                                            <td>(( role.role.address ))</td>
                                            <td><span class="badge badge-primary" v-for="tag in role.tags">(( tag ))</span>
                                            </td>
                                            <td>
                                                <a v-bind:href="setViewUrl(role.role.id)" class="btn btn-primary btn-sm pull-right">View</a>
                                            </td>
                                            <td>
                                                <a style="margin-right: 5px;" v-bind:href="setUrl(role.role.id)" class="btn btn-primary btn-sm pull-right">Edit</a>
                                            </td>
                                                <td>
                                                    <form action="{% url 'audition_management:settings' %}" method="post">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="form_type" value="delete">
                                                        <input type="hidden" name="pk" v-bind:value="role.role.id">
                                                        <button class="btn btn-danger btn-sm pull-right" type="submit">Delete</button>
                                                    </form>
                                                </td>
                                            
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
   
<!-- </div> -->
{% endblock %}

{% block js %}
<script type="text/javascript">
    
    $(".filter-collapsed-bar").click(function () {

        $header = $(".filter-collapsed-bar");
        $content = $header.next();

        $content.slideToggle(500, function () {

                if ($content.is(":visible")) {
                        $(".fa-chevron-up").css("display","inline-block");
                        $(".fa-chevron-down").css("display", "none");
                }
                else {
                        $(".fa-chevron-up").css("display", "none");
                        $(".fa-chevron-down").css("display","inline-block");
                }


        });
    });
    $(".filter-collapsed-bar-2").click(function () {

        $header = $(".filter-collapsed-bar-2");
        $content = $header.next();

        $content.slideToggle(500, function () {

                if ($content.is(":visible")) {
                        $(".2-up").css("display","inline-block");
                        $(".2-down").css("display", "none");
                }
                else {
                        $(".2-up").css("display", "none");
                        $(".2-down").css("display","inline-block");
                }


        });
    });
    confirm = function() {
        $.confirm({
                title: 'Warning',
                closeIcon: true, 
                content: "This action cannot be undone. Are you positive you want to delete your account?",
                type: 'red',
                typeAnimated: true,
                backgroundDismiss: false,
                buttons: {
                    yes: {
                        text: "Yes",
                        btnClass: 'btn-red',
                        action: function() {
                            $("#deleteAccount").submit()
                        }
                    },
                    no: {
                        text: 'No',
                    }
                }
            });
    }
    var unparsed = "{{roles}}"
    $(function() {
        unparsed = unparsed.split("&#39;").join("\"").split("&quot;").join("")
        if (unparsed.length > 0) {
            parsed = JSON.parse(unparsed);
        }
        else {
            parsed = [];
        }
         $("#results").floatThead({
            scrollContainer: function($table){
                return $table.closest('.wrapper');
            }
        });
         setTimeout(function() {
            $("#tagSelect").select2();
        }, 100);
        filterApp = new Vue({
            el: "#filterDiv",
            delimiters: ["((","))"],
            // This is data that needs to be 2 way bound (such as the filter input)
            // These cannot be set to undefined/null. 
            data: {
                filterText: "",
                filterTags: [],
                filterDate: "",
                tags: [],
                displayedRoles: [],
                allRoles: [],
                url: "{% url 'audition_management:edit-role' pk=0 %}",
                viewUrl: "{% url 'audition_management:role' pk=0 %}",
            },
            mounted: function() {
                // we save the 'this' keyword here because once we enter the next scope
                // 'this' will become the jQuery object $("#datetimepicker1") so
                // in order to access the app, we save it to a local variable
                var internalApp = this;
                this.allRoles = parsed
                this.displayedRoles = this.allRoles
                // populate the tags array with unique tags only
                for (var x = 0; x < parsed.length; x++) {
                    for (var y = 0; y < parsed[x].tags.length; y++) {
                        if (!this.tags.includes(parsed[x].tags[y])) {
                            this.tags.push(parsed[x].tags[y])
                        }
                    }
                }
                $('#datetimepicker1').datetimepicker({
                    "icons": {
                        "date": "glyphicon glyphicon-time",
                        "up": "fa fa-arrow-up",
                        "down": "fa fa-arrow-down"
                    }
                });
            },
            methods: {
                setUrl: function(num) {
                    return filterApp.url.replace("0", num)
                },
                combinedFilter: function() {
                    // filter by all available data
                    roles = filterApp.allRoles;
                    roles = filterApp.setFilterText(roles);
                    roles = filterApp.tagFilter(roles);
                    roles = filterApp.dateFilter(roles);
                    filterApp.displayedRoles = roles;
                },
                setFilterText: function(roles) {
                    // filter by text (this filters by case-insensitive name)
                    if (event) {
                        //update the text to filter by
                        filterText = $("#title").val();

                        //temp storage to eventually become the displayedRoles
                        var filteredRoles = [];

                        //filter the displayed roles based on the filterText
                        for (i = 0; i < roles.length; i++) {
                            if (roles[i].role.name.toLowerCase().indexOf(filterText.toLowerCase()) != -1) {
                                filteredRoles.push(roles[i]);
                            } 
                        }

                        //set the displayedRoles to our filtered roles
                        return filteredRoles;
                    }
                },
                tagFilter: function(roles) {
                    // filter by tags (all tags provided must be present)
                    selected = $("#tagSelect").val()
                    if (selected.length == 0) {
                        return roles;
                    }
                    else {
                        return roles.filter(function(role) {
                            var val = false;
                            for (var x = 0; x < selected.length; x++) {
                                if (role.tags.indexOf(selected[x]) > -1) {
                                    val = true;
                                }
                                else {
                                    return false;
                                }

                            }
                            return val;
                        })
                    }
                },
                dateFilter: function(roles) {
                    // filters by date (all events must occur after the provided date)
                    date = $("#datetimepicker1").data('DateTimePicker').date();
                    $('#datetimepicker1').datetimepicker({
                        date: date
                    });
                    if (date == null) {
                        return roles;
                    }
                    return roles.filter(function(role) {
                        var valid = false;
                        if (role.events.length == 0) {
                            return false;
                        }
                        for (var y = 0; y < role.events.length; y++) {
                            var dateString = role.events[y].event.date.split(" ")[0]
                            var momentDate = moment(dateString, "YYYY-MM-DD");
                            if (momentDate < date) {
                                return false;
                            }
                        }
                        return true;
                    })
                },
                resetFilters: function() {
                    filterApp.filterText = "";
                    filterApp.filterTags = [];
                    filterApp.filterDate = "";
                    filterApp.displayedRoles = filterApp.allRoles;
                    $("#tagSelect").val(null).trigger('change');
                },
                setViewUrl: function(num) {
                    return filterApp.viewUrl.replace("0", num)
                },
                setUrl: function(num) {
                    return filterApp.url.replace("0", num);
                },
                setDeleteUrl: function(num) {
                    return filterApp.deleteUrl.replace("0", num)
                },
            },
        });
    {% if not is_casting %}
        $('.formset_row').formset({
            addText: 'Add Previous Work',
            deleteText: 'Remove',
            prefix: 'form1',
            addCssClass: 'btn btn-sm btn-primary',
            deleteCssClass: 'btn btn-sm btn-danger',
        });
        data = [
            {% for tag in request.user.audition_account.tags.all %}
                { 
                    "tag": "{{tag.name}}", 
                    "id": {{tag.id}},
                },
            {% endfor %}
        ]
        app = new Vue({
            el: "#tagEdit",
            delimiters: ["((", "))"],
            data: {
                tags: [],
                insert: "",
                tagDelete: 0,
                addedTags: 0,
            },
            mounted: function() {
                this.tags = data;
            },
            methods: {
                updateTags: function(event) {
                    // this fires on input, if the comma delineator is found,
                    // it creates a tag and deletes the text
                    app.tagDelete = 0;
                    if (app.tags.length > 0) {
                        var id = app.tags[app.tags.length - 1].id
                        $("#" + id).css("background-color", "")
                    }
                    if (app.insert[app.insert.length - 1] == ",") {
                        if (app.insert.indexOf(" ")  > -1) {
                            tags = app.insert.substring(0, app.insert.length - 1).split(" ");
                            for (var x = 0; x < tags.length; x++) {
                                app.tags.push({
                                    "tag": tags[x],
                                    "id": "newId" + app.addedTags++,
                                })
                            }
                        }
                        else {
                            app.tags.push({
                                "tag": app.insert.substring(0, app.insert.length - 1),
                                "id": "newId" + app.addedTags++,
                            })
                        }
                        app.insert = "";
                    }
                    else {
                        // do nothing, typing
                    }
                },
                removeTags: function() {
                    // if the user hits backspace twice, then it highlights the
                    // tag to be deleted, a third backspace deletes the tag
                    app.tagDelete +=1;
                    if (app.insert == "" && app.tagDelete == 2) {
                        var id = app.tags[app.tags.length - 1].id
                        $("#" + id).css("background-color", "red")
                    }
                    else if (app.insert == "" && app.tagDelete == 3) {
                        app.tags.splice(app.tags.length - 1, 1);
                        app.tagDelete = 1;
                    }
                },
                subForm: function() {
                    $("#submitForm").prop('disabled',true);
                    $("#updatedTags").val(JSON.stringify(app.tags))
                    $("#tagEdit").submit();
                },
                deleteTag: function(id) {
                    // when the user clicks on the X for the tags, this method
                    // is used to splice out the tag from the array.`
                    for (var x = 0; x < app.tags.length; x++) {
                        if (app.tags[x].id == id) {
                            console.log(app.tags[x])
                            app.tags.splice(x, 1);
                            break;
                        }
                    }
                }
            }
        })
    {% endif %}
    })
</script>
{% endblock js %}